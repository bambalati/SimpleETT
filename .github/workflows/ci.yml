name: OMS CI

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master", "develop" ]

jobs:
  build-and-test:
    name: Build & Test (JDK ${{ matrix.java }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java: [ '21' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up /dev/shm for Aeron (required by MediaDriver)
        run: |
          sudo mkdir -p /dev/shm
          sudo chmod 777 /dev/shm

      - name: Build all modules (skip tests for fast feedback)
        run: mvn clean package -DskipTests -B

      - name: Run unit tests
        run: mvn test -pl engine -B

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports-jdk${{ matrix.java }}
          path: '**/target/surefire-reports/*.xml'
          retention-days: 7

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check for compiler warnings
        run: mvn clean compile -B 2>&1 | tee compile.log

      - name: Verify no snapshot dependencies in release builds
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          if grep -r "SNAPSHOT" pom.xml */pom.xml; then
            echo "ERROR: SNAPSHOT dependencies found in a release tag build"
            exit 1
          fi

  integration-smoke:
    name: Integration Smoke Test
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build fat jars
        run: mvn clean package -DskipTests -B

      - name: Set up /dev/shm
        run: sudo chmod 777 /dev/shm

      - name: Start gateway (background)
        run: |
          java \
            -Daeron.dir=/dev/shm/aeron-oms-ci \
            -jar gateway/target/gateway-fat.jar &
          echo $! > gateway.pid
          echo "Gateway PID: $(cat gateway.pid)"
          # Wait for gateway to be ready (poll TCP port 7001)
          for i in $(seq 1 30); do
            if nc -z localhost 7001 2>/dev/null; then
              echo "Gateway is up after ${i}s"
              break
            fi
            echo "Waiting for gateway... (${i}/30)"
            sleep 1
          done
          nc -z localhost 7001 || (echo "Gateway failed to start" && exit 1)

      - name: Run load generator smoke test (500 orders, 5 secs)
        run: |
          java \
            -jar tools/target/loadgen-fat.jar \
            src/main/resources/oms.yml \
            100 \
            5 \
          2>&1 | tee loadgen.log
          # Verify acks were received
          grep -E "Acks:" loadgen.log
          ACKS=$(grep "Acks:" loadgen.log | grep -oP '\d+(?= \()' || echo "0")
          echo "Acks received: $ACKS"
          [ "$ACKS" -gt 0 ] || (echo "No acks received â€” smoke test failed" && exit 1)

      - name: Stop gateway
        if: always()
        run: |
          if [ -f gateway.pid ]; then
            kill $(cat gateway.pid) || true
          fi

      - name: Upload smoke test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: |
            loadgen.log
          retention-days: 3
